# 前端单元测试笔记
*leeching 2015-12-27*

前端的业务涉及到三个方面
* 页面样式
* 与服务器的数据通信
* 页面的脚本逻辑

其中，样式和数据通信是无法通过单元测试覆盖的。

## 单元测试的覆盖边界
样式可以通过获取dom上的class来间接检测，但是，以此为基础的单元测试编写成本过高，成本的收益转化率很低。所以，不应该对样式做**专门的单元测试**。

对于客户端的js脚本而言，一次数据通信可以被分为几个阶段。
* 收集数据，并转化为预先约定好的，服务器能够处理的数据格式
* 向服务器发起请求
* 服务器处理完毕之后，返回响应
* 处理响应内容，比如将数据渲染到页面，或者将请求成功与否的信息以ui的形式告知用户

前端的单元测试应该只覆盖到第一和第四阶段，对于第二和第三阶段，应该通过mock数据提供对应的假设条件。通常，不会考虑浏览器无法发送请求（比如网络状况不佳）或者服务器无法处理请求（比如502错误）的情况。除非js脚本需要处理这些极端情况，那么就应该为这些情况编写专门的mock数据，来测试脚本逻辑是否运行正常。

## 单元测试和代码可靠性
编写单元测试的主要目的是，**维持代码的可靠性**。

因为单元测试有覆盖边界的限制，所以无法对整个项目的代码可靠性负责。单元测试对应于模块或者组件，集成测试才对应于系统或者项目。

而且，对于模块（或者组件）代码来说，单元测试也只能做到被动的报错和提醒，无法主动提升代码的质量。不能说，因为有了单元测试，所以代码的质量就增强了。对于一个逻辑混乱，接口抽象糟糕的模块（或者组件）来说，即使编写再多的单元测试，出错也只是时间问题。而且在正常情况下，很难为糟糕的代码编写出可靠的单元测试。

## 可测试的代码
单元测试以测试用例为单位进行编写，一个测试用例就是将模块代码在一个给定的环境下运行一遍，检测运行结果是否符合预期。所以说，单元测试对代码是有一定要求的，**并不是说，代码可运行，就可以被测试，尤其是单元测试**。一个可以被单元测试的代码，最起码要满足以下几个条件
* 是模块化的，并且能独立运行的
* 运行结果是可以被检测的，被预期的

在尽可能的前提下，代码还应该做到同步执行，虽然某些测试框架可以自动处理异步问题（比如jest），但是相比同步代码，异步代码的测试效率较低，测试结果有时也不那么可靠（个人看法）。

## 测试用例
在模块的开发维护过程中，测试用例的典型生存周期如下
* 编写：以TDD为例，一般在开发前（或开发过程中），根据模块的逻辑，编写测试用例
* 运行：反复运行测试用例，根据报错反馈，修正业务代码，直到测试用例通过
* 再运行：在项目代码库中，无论改动、新增，或者删除任何业务代码，都应该将现有的全部测试用例运行一遍，以保证当前的改动不会影响到其他模块
* 更新：在项目迭代过程中，测试用例应该随着模块功能演变做对应更新

模块的测试用例应该尽可能多地覆盖各种情况，以下是在前端单元测试中比较常见的需要验证的功能：
* 提交服务器的数据格式是否准确
* 服务器返回数据的ui渲染是否正常
* 各类回调函数（比如事件回调，ajax回调等）的运行是否正常
* 辅助函数（不直接参与业务逻辑，但是能简化业务逻辑的函数封装）的运行是否正常

测试js函数是很具有挑战性的事情。函数在js中地位最高，js的函数使用也相当灵活，这也导致了很多不够严谨的函数使用。这些函数仅能实现业务需求，而缺乏足够的逻辑抽象。像这样的函数多半是不可测的。一个高质量的可被测试的js函数应该具有以下几个特点：
* 只完成一个特定的可控的业务逻辑，如果这个业务逻辑可以拆分，那么应该尽可能地拆分成多个函数，以简化单个函数的逻辑。类似于将一个复杂的组件拆分成一个父组件和一堆子组件，但在组织上应该是管道状的而不是树状的
* 函数编写应该明确是对值的操作还是对引用的操作，两者不应该混淆
* 函数应该尽可能纯粹，如果确实需要带入副作用（比如改变某个处于外部作用域的变量值），副作用应当尽可能小，并且绝对可控
* 函数运行所带来的结果是有限的，并且是可预测的
* 作为过程被调用的函数，没有必要有返回值，但是，调用函数的结果至少能够通过某个变量被间接探知，并且这种探知成本应当尽可能低

另，js函数最能体现出工程师的代码水准和代码品味。

## 测试成本
单元测试存在的价值在于，编写测试的成本小，并且带来收益可观。

在实际操作过程中，会出现一种令人厌恶的情况。某个测试用例无法编写，或者说，编写测试用例的成本非常高，或者，写出来的测试用例逻辑复杂。这种问题绝大部分是因为业务代码的抽象不够好（或者依赖了过量的第三方库，但这种情况没有做讨论的价值）。如果确信，业务代码的抽象没有问题，那么，我的个人看法是，就干脆放弃为这部分代码做测试。

在测试中，测试覆盖率很重要，但我的看法是，测试成本和测试覆盖率同样重要。如果测试成本上升和测试收益下降的总和打破了某个临界点，那么就意味着项目整体收益的下降，这显然是得不偿失的。不能陷入为了测试而测试的怪圈。
